# 汇总易AI化 MVP版本需求梳理
## 一、功能模块表格
| 一级模块 | 二级模块 | 核心能力 | MVP版本状态 | 核心交互/设计参考 | 关键备注 |
|---------|---------|---------|------------|----------------|---------|
| 首页 | 核心交互区 | 1. AI指令输入（意图识别、RAG联动）<br>2. 快捷场景按钮（通用表单/文件签署/更多）<br>3. 核心Slogan强化价值 | 核心功能，全量落地 | 输入框占首页80%宽度，快捷按钮为卡片式hover高亮；通用表单点击弹出结构化输入弹窗 | 输入指令后直接跳转任务规划界面，核心交互为“AI一键生成” |
|  | 子菜单（我创建的任务） | 1. 数据看板（完成率/进行中任务/待上交材料）<br>2. 多维度筛选<br>3. 任务列表管理（编辑/查看/数据分析） | 核心功能，全量落地 | 看板为横向卡片，列表支持排序/分页，参考办公类产品数据展示逻辑 | 聚焦任务创建人视角，支持进度监控与数据统计 |
|  | 子菜单（分配给我的任务） | 1. 精准筛选（逾期/未完成快捷筛选）<br>2. 任务列表（状态提醒灯/填报操作）<br>3. 截止时间倒计时 | 核心功能，全量落地 | 状态提醒灯（红/黄/绿）区分逾期/临期/正常，列表聚焦填报人操作 | 聚焦任务接收人视角，支持快速填报与进度跟踪 |
| 任务规划界面 | 画布式节点生成 | 1. AI自动生成6类节点（任务规划→RAG检索→收集对象确认→收集内容确认→校验催办补充→执行确认）<br>2. 节点流转（AI主导，用户确认/补充）<br>3. 历史规划记录/对话记录管理 | 核心功能，全量落地 | 参考扣子空间画布风格，节点为圆角卡片，支持折叠/展开/溯源 | 核心逻辑：AI自动配置+强制确认，无需手动拖拽节点 |
| 任务详情页 | 任务进行中状态 | 1. 基础信息展示+截止提醒<br>2. 创建人快捷操作（校验规则/发起催办/关联任务）<br>3. 填报进度卡片（状态/打分/查看） | 核心功能，全量落地 | 左侧固定菜单栏，右侧分上下区域；催办联动AI数字人小清 | 区分创建人/填报人视角，创建人可发起催办/调整规则 |
|  | 任务完成状态 | 1. 智能汇总（新开标签页，多模态分析）<br>2. 填报结果管理（表格/卡片，支持筛选/导出/AI清洗）<br>3. 数据可视化与溯源 | 核心功能，全量落地 | 参考问卷星答卷列表，表格支持星标/批量操作/AI清洗 | 智能汇总为核心AI能力，支持“分析结论-原始数据”溯源 |
| 收集对象管理库 | 填报组创建 | 1. 手动创建（组织架构联动）<br>2. 批量导入（Excel模板+AI校验）<br>3. 历史任务同步/复制已有组 | 核心功能，全量落地 | 右侧抽屉弹窗创建，组织架构树支持搜索/多选 | 适配内部“个人/部门/跨部门”组场景，降低操作成本 |
|  | 填报组管理 | 1. 编辑/删除/星标/排序<br>2. 详情查看/导出<br>3. 回收站（30天保留/恢复） | 核心功能，全量落地 | 列表式展示，操作按钮为图标化设计，支持批量操作 | 权限管控：仅创建者/管理员可编辑/删除 |
| 模板库 | 任务下发内容模板 | 1. AI创建（prompt输入→AI生成→编辑保存）<br>2. 手动编辑（可视化拖拽工作台）<br>3. 模板复用/版本管理 | 核心功能，全量落地 | 参考问卷星AI创建逻辑，编辑工作台分组件库/编辑区/属性区 | 支持AI生成模板初稿，用户微调，提升创建效率 |
|  | 汇总报告模板 | 1. 手动创建/AI快速生成<br>2. 模板复用/关联任务生成报告 | 预留功能，MVP仅展示框架 | 与任务下发模板库共用布局，切换子库时同步更新界面 | 核心为联动收集结果生成标准化报告 |
| 后端支撑 | 任务表单配置 | 1. 手动填报字段（基础信息/收集对象/校验规则）<br>2. AI化配置（prompt/模板匹配/RAG阈值）<br>3. 催办配置（小清数字人固定规则） | 核心功能，全量落地 | 字段分必填/可选，MVP简化催办配置（强制开启小清） | 以task_id为核心关联所有数据，支撑任务全生命周期 |
|  | 数据存储与流转 | 1. 核心表（任务主表/填报结果/催办日志）<br>2. 复用现有表（组织架构/填报组）<br>3. 数据权限与备份 | 核心功能，全量落地 | 行级/字段级权限管控，核心表每日备份 | MVP优先保障手动任务流转，AI相关表预留 |

## 二、核心数据结构
### 1. MVP核心必建表（优先级最高，支撑手动任务全流程）
| 表名 | 核心存储字段（MVP版本） | 字段类型 | 主键/唯一键 | 关联字段 | 核心用途 |
|------|------------------------|----------|-------------|----------|----------|
| task_main（任务主表） | task_id<br>task_name<br>task_desc<br>deadline_time<br>creator_id<br>create_time<br>effective_time<br>task_status<br>fill_group_id<br>fill_user_ids<br>fill_form_id<br>must_fill_field_ids<br>is_single_fill<br>is_xiaoqing_remind<br>remind_scenes<br>remind_frequency<br>remind_way<br>remind_time<br>check_rules<br>is_ai_check<br>related_task_ids<br>view_permission_type<br>edit_permission_id<br>data_export_permission | 字符串（唯一）<br>字符串<br>文本<br>时间戳<br>字符串<br>时间戳<br>时间戳<br>枚举（未生效/进行中/已截止/已归档/已作废）<br>字符串/数组<br>字符串/数组<br>字符串<br>数组<br>布尔值<br>布尔值<br>数组<br>枚举（单次）<br>数组<br>数组（时间戳）<br>文本<br>布尔值<br>字符串/数组<br>枚举（仅创建人）<br>字符串/数组<br>枚举（仅创建人） | task_id（主键） | - | 存储任务全量核心配置，作为所有子表的关联核心，支撑MVP手动任务创建、流转、权限管控 |
| task_fill_user_rel（填报人任务关联表） | rel_id<br>task_id<br>fill_user_id<br>fill_status（未填报/已填报/已逾期）<br>fill_time<br>fill_score（AI校验得分） | 字符串（唯一）<br>字符串<br>字符串<br>枚举<br>时间戳<br>整数（0-100） | rel_id（主键）<br>联合唯一：task_id + fill_user_id | task_id（关联task_main）<br>fill_user_id（关联集团组织架构表） | 跟踪每个填报人的任务状态，支撑催办触发、时效性统计、AI打分结果存储 |
| form_field_config（表单字段配置表） | config_id<br>fill_form_id<br>field_name<br>field_type（单选/多选/文本/附件等）<br>is_required<br>field_check_rule | 字符串（唯一）<br>字符串<br>字符串<br>枚举<br>布尔值<br>文本 | config_id（主键）<br>联合唯一：fill_form_id + field_name | fill_form_id（关联task_main） | 存储表单字段配置，支撑前端表单渲染、后端手动校验、AI校验规则匹配 |
| fill_result（填报结果表） | result_id<br>task_id<br>fill_user_id<br>fill_data（JSON格式存储填报内容）<br>attach_path（附件路径，MVP预留）<br>submit_time<br>update_record（修改时间/次数） | 字符串（唯一）<br>字符串<br>字符串<br>JSON<br>字符串/数组<br>时间戳<br>JSON | result_id（主键）<br>联合唯一：task_id + fill_user_id | task_id（关联task_main）<br>fill_user_id（关联集团组织架构表） | 存储填报人提交的核心数据，支撑手动查询、AI汇总分析的数据来源 |
| task_remind_log（催办日志表） | log_id<br>task_id<br>remind_user_id<br>remind_scene<br>remind_time<br>remind_way<br>remind_result（成功/失败）<br>remind_content（催办话术） | 字符串（唯一）<br>字符串<br>字符串<br>枚举（下发提醒/截止前提醒/创建者完成提醒）<br>时间戳<br>数组（系统消息/企业微信）<br>枚举<br>文本 | log_id（主键） | task_id（关联task_main）<br>remind_user_id（关联集团组织架构表） | 记录小清数字人催办全量日志，支撑催办效果追溯、手动核查 |
| task_check_config（校验规则表） | check_id<br>task_id<br>check_rules<br>is_ai_check<br>ai_check_log（AI校验结果日志） | 字符串（唯一）<br>字符串<br>文本<br>布尔值<br>JSON | check_id（主键）<br>联合唯一：task_id | task_id（关联task_main） | 存储任务校验规则，支撑手动校验、AI自动校验的规则匹配与结果记录 |

### 2. MVP复用现有表（降低开发成本）
| 复用表名（集团现有） | 核心复用字段 | 关联场景 | 用途 |
|----------------------|--------------|----------|------|
| 组织架构表 | user_id<br>user_name<br>dept_id<br>dept_name<br>post_name | 收集对象选择、催办通知、权限管控 | 快速获取填报人基础信息，无需重复存储，支撑催办下发、权限过滤 |
| fill_group（填报组表） | group_id<br>group_name<br>group_member_ids<br>creator_id | 收集对象批量选择 | 支撑填报组快速关联任务，减少用户手动选择单个用户的成本 |
| template_lib（模板库表） | template_id<br>template_name<br>field_config（表单字段配置） | 收集内容快速配置 | 支撑表单模板复用，降低用户手动拖拽配置表单的成本 |

### 3. 高级需求
| 预留表名 | 存储内容 | 迭代用途 |
|----------|----------|----------|
| ai_task_config | AI配置（ai_prompt、rag_confidence_threshold）、AI模板匹配结果 | 支撑AI生成表单、AI汇总分析、RAG知识库匹配 |
| task_attach | 附件关联信息、存储路径、文件大小、文件类型 | 支撑附件上传/下载/预览功能 |
| task_operation_log | 任务操作人、操作类型、操作时间、操作结果 | 支撑全流程操作审计 |

## 三、核心业务逻辑需求
### 1. 任务全生命周期流转逻辑（MVP核心）
#### （1）任务创建阶段
- 接收前端提交的任务配置参数，校验必填字段（task_name、deadline_time、fill_group_id/fill_user_ids、fill_form_id），非必填字段赋予默认值；
- 生成唯一task_id，将配置写入`task_main`表，初始任务状态设为"未生效"；
- 解析fill_group_id/fill_user_ids，关联集团组织架构表/填报组表，获取所有填报人ID，批量写入`task_fill_user_rel`表，初始填报状态设为"未填报"；
- 解析fill_form_id，关联`form_field_config`表，提取必填字段ID，更新`task_main`表的must_fill_field_ids字段。

#### （2）任务生效阶段
- 到达`effective_time`（默认任务创建时间），自动将`task_main`表的task_status更新为"进行中"；
- 触发小清"任务下发提醒"：遍历`task_fill_user_rel`表中该任务的所有填报人，按`remind_way`（系统消息+企业微信）推送提醒，同时写入`task_remind_log`表，记录催办场景、时间、方式、结果；
- 若触发失败（如企业微信接口异常），标记`task_remind_log`表的remind_result为"失败"，并支持手动重试触发。

#### （3）填报提交流转
- 接收填报人提交的内容，校验字段完整性（匹配must_fill_field_ids），未通过则返回前端校验失败提示；
- 字段完整性校验通过后，执行`task_check_config`表中的check_rules手动校验（如手机号格式、金额范围），未通过则返回具体失败原因；
- 手动校验通过后，强制触发AI校验（is_ai_check默认true），基于填报内容完整性、合规性打分（0-100分），将得分写入`task_fill_user_rel`表的fill_score字段；
- 校验全部通过后，将填报内容JSON化写入`fill_result`表，更新`task_fill_user_rel`表的fill_status为"已填报"、fill_time为当前时间。

#### （4）催办触发逻辑
- 定时任务扫描`task_main`表中状态为"进行中"的任务，匹配`remind_time`中的时间节点；
- 对`task_fill_user_rel`表中该任务下"未填报"的填报人，按`remind_scenes`（下发提醒/截止前提醒）、`remind_way`（系统消息+企业微信）触发小清催办；
- 每触发一次催办，写入`task_remind_log`表，记录催办详情；
- 所有填报人完成填报后，触发"创建者任务完成提醒"，向creator_id推送系统消息+企业微信通知。

#### （5）任务截止/归档阶段
- 到达`deadline_time`，自动将`task_main`表的task_status更新为"已截止"，关闭前端填报入口；
- 对`task_fill_user_rel`表中仍为"未填报"的记录，更新fill_status为"已逾期"；
- 到达`archive_time`（默认截止后7天），自动将task_status更新为"已归档"，归档后任务仅支持查看，不可编辑/催办。

### 2. 校验逻辑（MVP强制AI校验）
#### （1）手动校验
- 基于`task_check_config`表的check_rules，对填报内容执行规则匹配（如"金额>0""文本非空"）；
- 支持预设规则快速匹配（手机号/邮箱格式、日期格式），自定义规则执行文本模糊匹配。

#### （2）AI校验（MVP强制开启，不可关闭）
- 对通过手动校验的填报内容，执行AI语义分析，校验内容合规性、完整性；
- 按预设维度打分（字段完整性30分、内容合规性40分、格式规范性30分），总分0-100分；
- 打分结果写入`task_fill_user_rel`表，AI校验日志写入`task_check_config`表的ai_check_log字段。

### 3. 数据关联逻辑
- **核心关联**：以task_id为唯一标识，支持`task_main`→`task_fill_user_rel`→`fill_result`→`task_remind_log`→`task_check_config`的联表查询，快速获取任务全量数据；
- **收集对象关联**：fill_group_id/fill_user_ids关联集团组织架构表/填报组表，支持按部门/岗位筛选填报人；
- **校验规则关联**：check_rules关联`fill_result`表，填报提交后自动匹配规则执行校验；
- **催办日志关联**：remind_scenes/remind_way关联`task_remind_log`表，支持按催办场景/方式筛选日志。

### 4. 权限管控逻辑（MVP简化版）
#### （1）行级权限
- 任务查询时，按`task_main`表的view_permission_type（默认仅创建人）过滤，仅返回当前用户为creator_id的任务；
- 填报人仅可查询自己的填报记录，不可查看其他填报人的数据。

#### （2）字段级权限
- 敏感字段（fill_score、check_rules、ai_check_log）仅对creator_id可见，前端查询时自动过滤；
- 填报人仅可查看自己的fill_score，不可查看整体打分统计。

#### （3）操作权限
- 任务编辑：仅`task_main`表的edit_permission_id（默认creator_id）可执行，非授权用户返回权限不足；
- 数据导出：仅`task_main`表的data_export_permission（默认creator_id）可执行，导出内容仅包含授权范围内的数据。

### 5. 数据备份与合规逻辑
#### （1）数据备份
- 核心表（task_main、task_fill_user_rel、fill_result、task_remind_log）每日凌晨自动全量备份，备份数据保留90天；
- 支持手动触发备份，备份文件存储至集团指定存储介质。

#### （2）数据加密
- 填报人隐私信息（手机号、邮箱）、校验规则（check_rules）加密存储，查询时解密返回；
- 附件路径（预留）加密存储，仅授权用户可获取真实路径。

#### （3）数据清理
- 归档任务（task_status=已归档）超过1年的，可手动触发清理，清理前需二次确认；
- 备份数据超过90天的，自动清理，清理日志留存1年。

## 四、核心字段约束与默认值（MVP版本）
| 字段名（task_main表） | 约束规则 | MVP默认值 | 异常处理 |
|-----------------------|----------|-----------|----------|
| task_name | 非空、长度≤50字符 | - | 长度超限返回"任务名称不可超过50字符" |
| deadline_time | 非空、需晚于当前时间 | 当前时间+3天（前端参考值，需用户确认） | 时间早于当前时间返回"截止时间需晚于当前时间" |
| fill_group_id/fill_user_ids | 二选一非空 | - | 均为空返回"需选择至少一名填报人" |
| fill_form_id | 非空、需存在于form_field_config表 | - | 不存在返回"表单配置不存在，请重新选择" |
| is_xiaoqing_remind | 布尔值 | true（不可取消） | - |
| remind_scenes | 数组、仅支持指定值 | ["下发提醒","截止前提醒","创建者完成提醒"] | 包含非指定值自动过滤 |
| remind_frequency | 枚举、仅支持"单次" | 单次 | 传入其他值自动重置为"单次" |
| remind_way | 数组、仅支持指定值 | ["系统消息","企业微信"] | 包含非指定值自动过滤 |
| is_ai_check | 布尔值 | true（不可取消） | - |
| view_permission_type | 枚举、仅支持"仅创建人" | 仅创建人 | 传入其他值自动重置为"仅创建人" |
| data_export_permission | 枚举、仅支持"仅创建人" | 仅创建人 | 传入其他值自动重置为"仅创建人" |

## 五、表单交互逻辑
### 1. 手动创建表单交互
#### 触发条件
用户在首页点击“通用表单”→弹出结构化输入弹窗；或在任务规划界面手动配置表单。

#### 操作步骤
1. **基础信息填写**：输入任务名称（必填）、描述（可选）、截止时间（必填，默认当前+3天）；
2. **收集对象选择**：勾选填报组/单个用户（关联组织架构，支持搜索）；
3. **收集内容配置**：
   - 选择预置模板/手动拖拽字段（单选/文本/附件等）；
   - 设置字段必填性、校验规则（如手机号格式、附件大小）；
4. **校验/催办确认**：确认校验规则，MVP强制开启AI校验+小清催办；
5. **提交创建**：点击“确认执行”，系统落地配置，生成任务。

#### 反馈逻辑
- 填写不完整：按钮置灰，hover提示缺失项；
- 创建成功：弹窗提示“任务创建成功”，跳转至任务详情页；
- 异常处理：名称重复/权限不足时，标红提示并给出解决方案。

### 2. AI创建表单交互
#### 触发条件
用户在首页输入指令（如“创建部门满意度调研问卷”）；或在模板库点击“AI创建任务模板”。

#### 操作步骤
1. **指令输入**：输入自然语言指令/prompt（支持参考示例）；
2. **AI生成**：3秒内生成表单初稿（含字段/题型/校验规则）；
3. **预览编辑**：可视化调整字段顺序/必填性/校验规则；
4. **保存确认**：选择模板权限（个人/部门），保存至模板库/直接创建任务。

#### 反馈逻辑
- 指令模糊：AI动态问询补充信息（如“调研截止时间？”）；
- 生成完成：弹窗提示“模板生成成功”，支持一键复用；
- 编辑反馈：实时校验字段配置，冲突时标红提示（如“两个字段名称重复”）。

### 3. 填报提交流互
#### 触发条件
填报人在“分配给我的任务”中点击“填报提交”。

#### 操作步骤
1. **表单渲染**：前端按配置渲染字段（支持逻辑跳转/必填标红）；
2. **内容填写**：填写文本/选择选项/上传附件（支持预览）；
3. **提交校验**：
   - 前端先校验必填项/格式（如日期格式），失败则标红提示；
   - 后端执行手动校验（附件大小/金额范围）+ AI校验（语义完整性）；
4. **提交成功**：更新填报状态，生成得分，关闭填报入口。

#### 异常处理
- 校验失败：弹窗展示失败原因（如“预算金额需≤10000元”），返回表单修改；
- 附件超限：提示“附件大小≤200M”，支持重新上传；
- 重复提交：MVP默认禁止，提示“仅可提交1次”。

### 4. 校验交互（创建人视角）
#### 触发条件
创建人在任务详情页点击“校验规则”按钮。

#### 操作步骤
1. **弹窗展示**：显示当前校验规则（如“预算金额需为正数”）；
2. **规则修改**：手动编辑规则/点击“问小影”优化规则；
3. **确认更新**：保存规则，系统向填报人推送更新通知；
4. **重新校验**：对已提交内容按新规则重新打分，标注异常。

#### 反馈逻辑
- 规则更新成功：弹窗提示“已同步至所有填报人”；
- 重新校验完成：展示“XX条内容规则变更后异常”，支持定位至对应填报人。

### 5. 催办交互（创建人视角）
#### 触发条件
创建人在任务详情页点击“发起催办”按钮。

#### 操作步骤
1. **对话触发**：右侧弹出小清对话面板，主动问询催办范围/话术；
2. **配置确认**：用户输入“催办全部未提交人员，话术：请尽快提交”；
3. **AI解析**：提取催办范围、话术，生成确认信息；
4. **执行催办**：点击“确认发起”，小清按系统消息+企业微信推送提醒；
5. **进度查看**：对话面板展示“已向X人发送，X人未送达”。

#### 异常处理
- 催办失败：提示“部分用户未开通企业微信，已通过系统消息推送”；
- 重复催办：提示“1小时内已发起过催办，是否继续？”。